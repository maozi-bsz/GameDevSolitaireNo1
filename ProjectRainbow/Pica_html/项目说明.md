# 无人红色皮卡的安保之旅 — 项目说明文档

本文档为项目与功能的总结说明，便于查阅规则、机制与扩展方式。

---

## 一、项目概览

- **类型**：文字 + 选择驱动的公路生存小游戏，界面由汉字「皮卡」与道路字符构成。
- **入口**：`index.html`（标题/开始/重置）、`game.html`（主游戏页）。
- **核心 JS 目录** `js/`：
  - **game_config/**：数据与配置（事件、物品、商人、乘客、皮卡样式、结局）
  - **gameplay/**：玩法逻辑（事件调度、文本推进、游戏结束）
  - **game_show/**：显示与动效（皮卡、道路、弹窗、库存、tooltip）
  - **game_system/**：状态与存档（gameState、truckState、inventory、save/load）

---

## 二、游戏规则摘要

### 2.1 核心数值（0–100）

| 数值   | 说明           | 归零后果     |
|--------|----------------|--------------|
| 燃油   | 每行行驶按比例消耗 | 结局「燃油耗尽」 |
| 耐久   | 事件/使用物品可增减 | 结局「车辆报废」 |
| 舒适   | 事件/乘客行为影响 | 结局「众叛亲离」 |

### 2.2 进程与事件

- 文本每 **2 行** 判定一次是否触发**事件节点**（弹窗选择）。
- **行驶中**每 1 行文本都会：增加随机 **1～4 km** 里程、按里程比例扣燃油、刷新「里程记录」与「车上成员」的距目的地剩余、检查是否有乘客到达目的地下车。
- 每 **25 km** 强制一次**昼夜休息**事件。
- 最近 **4 次**事件内不重复同一事件；**休息类**（休息站、工坊、加油站）每 25 km 周期内最多 **3 次**。

### 2.3 资源与背包

- **金币**：初始 6，用于商人、休息等；可通过事件与到达目的地（如妇人）获得。
- **后备箱**：载重 50，物品有重量；可**合成**、与商人买卖、在休息时使用消耗品；**支持拖拽调整物品顺序**（顺序会存档）。

### 2.4 好感度（0–100）

- 每位乘客有独立好感度，默认 50；上车时初始化。
- 事件选项可写 **favor: { "鹿": 10 }** 或 **favorAll: 5**，仅对当前在车上的乘客生效。
- 车上成员列表中显示「♥ 数值」，颜色随好感变化（绿/黄/红）。

---

## 三、事件效果一览

| 效果 | 说明 |
|------|------|
| addItems / removeItems | `[{ id, quantity }]` |
| gold | 正为获得，负为消耗 |
| fuel / durability / comfort | 数值变动（耐久变动会触发屏幕抖动） |
| addPassenger / removePassenger | 乘客上下车（有渐显动效） |
| **favor** | `{ "鹿": 10 }` 对指定乘客加减好感，仅车上乘客生效 |
| **favorAll** | 对当前车上所有乘客加减相同好感 |
| **setPassengerGetOffMileage** | `{ "旅行者": [10, 25] }` 随机 10～25 km 后下车；也可写固定数字 |
| **strayCatFeedAndMaybeBoard** | 流浪猫喂食计数，第三次喂食时猫上车 |
| unlockEvents | `["event_id"]` |
| openMerchantModal / openRestModal / openCraftingModal | 打开对应界面 |
| gameOver | true 时触发游戏结束 |
| **condition.notPassenger** | 指定乘客已在车上则不触发该事件（如流浪艺人已上车不再触发） |
| 复合效果 | `weighted` / `chance` / `choice` / `sequence`（见 `processEffects`） |

---

## 四、乘客与目的地

- **乘客配置**（`passenger-config.js`）：鹿、猎人、骚福瑞、旅行者、年迈妇人、猫等，含显示字、颜色、在皮卡上的位置。
- **有目的地的乘客**：旅行者、年迈妇人。上车时通过 **setPassengerGetOffMileage** 设置「再行驶 X km 后下车」（可为固定数或 `[min, max]` 随机）。
- 车上成员列表会显示「**还有 X km**」；到达后自动下车并追加事件文案（旅行者留纪念、妇人留感谢费 30 金币）。
- **流浪艺人**：已上车后不再触发流浪艺人事件（`condition: { notPassenger: "流浪艺人" }`）。
- **流浪猫**：选「喂点零食」累计次数，**第三次**时猫上车（`strayCatFeedAndMaybeBoard` + `gameState.strayCatFeedCount`）。

---

## 五、界面与动效

### 5.1 里程记录

- 位置：右侧面板。
- **本次里程**：当前档已行驶 km，行驶中每行文本实时增加。
- **历史最高**：localStorage 存储，跨档保留；存档与游戏结束时会更新。

### 5.2 车上成员

- 位置：游戏画面下方，**横向排列**。
- 显示乘客名、好感度（♥）、有目的地的显示「还有 X km」。
- 新成员出现时有**渐显**动效（`passenger-item-enter`）。

### 5.3 后备箱

- 物品行支持：**悬停 tooltip**（与画面风格一致，显示使用后效果）、**拖拽调整顺序**（松手后保存）。
- 新获得的物品行有**渐显**动效（`inventory-item-enter`，通过 `gameState._newItemIds` 标记）。

### 5.4 耐久与抖动

- 耐久变动时（事件效果或使用修理/恢复类物品）：**triggerScreenShake()** 对 `#game-canvas` 施加约 0.45s 的屏幕抖动动画。

### 5.5 事件文本框

- 滚动条样式与画面风格一致（深底 + 红色滑块）。

---

## 六、文件与脚本加载顺序（game.html）

1. Tailwind、页面结构  
2. `game_config`：game-config、passenger、truck-style、items、merchant、endings、events 系列、inventory-events  
3. `game_system`：game-state、save-system、text-control、inventory-system  
4. `game_show`：truck-display、event-animation、inventory-display、road  
5. `gameplay`：event-handler、game-over、text-generation  
6. 主入口：`text.js`（DOMContentLoaded 后 initializeGame）

---

## 七、如何扩展

### 新增事件

- 在 `js/game_config/events/` 对应文件中按现有格式添加事件对象，并确保在 `events-index.js` 的合并源中（或新文件被引用）。
- 使用 **condition**：`requiresPassenger`、`requiresItem`、`minGold`、**notPassenger**（某乘客在车上则不触发）。
- 使用 **favor** / **favorAll**、**setPassengerGetOffMileage** 等效果（见上文）。

### 新增乘客

- 在 `passenger-config.js` 的 `PASSENGER_CONFIG` 中增加：`displayChars`、`color`、`positions`（在皮卡模板中的行列）。
- 事件里用 **addPassenger: "名字"**；若需到站下车，配合 **setPassengerGetOffMileage**。

### 新增物品

- 在 `items-config.js` 的 `ITEMS_CONFIG` 中增加属性（含 `useEffect` 则会在后备箱 tooltip 中显示「使用后：……」）；合成配方写在 `CRAFTING_RECIPES`。

### 修改平衡

- 事件频率：`GAME_CONFIG.triggerInterval`、各事件 `triggerWeight`。
- 休息与昼夜：`overnightRestInterval`、`maxRestPerCycle`。
- 里程与燃油：`js/gameplay/event-handler.js` 中 `KM_PER_TICK_MIN/MAX`、`GAME_CONFIG.fuelConsumptionPer5km`。
- 物价：`merchant-config.js`。

---

## 八、存档与本地存储

- **Cookie**（`GAME_CONFIG.cookieName`）：保存 `gameState`、`truckState`、`inventoryState`（含物品顺序、好感度、目的地里程、流浪猫喂食次数等）。
- **localStorage**：仅用于「历史最高里程」记录（`chinese_truck_adventure_mileage_best`），与存档独立。

---

以上为当前版本的项目与功能总结；更偏开发细节的事件流程与函数说明见 **README.md**。
